<!-- sections/pickup-calendar.liquid -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

<div class="pickup-calendar">
  <h3>Choose Pickup Date & Time</h3>
  
  <label for="pickup-date">Pickup Date:</label><br>
  <input
    type="text"
    id="pickup-date"
    name="attributes[Pickup Date]"
    value="{{ cart.attributes['Pickup Date'] }}"
    placeholder="Select pickup date"
    required
  ><br><br>

  <label for="pickup-time">Pickup Time:</label><br>
  <input
    type="time"
    id="pickup-time"
    name="attributes[Pickup Time]"
    value="{{ cart.attributes['Pickup Time'] }}"
    required
  >
</div>

{% schema %}
{
  "name": "Pickup Calendar",
  "settings": [
    {
      "type": "range",
      "id": "minimum_days_notice",
      "label": "Minimum days in advance",
      "min": 0,
      "max": 30,
      "default": 14
    },
    {
      "type": "select",
      "id": "available_days",
      "label": "Available pickup day",
      "options": [
        { "value": "0", "label": "Sunday" },
        { "value": "1", "label": "Monday" },
        { "value": "2", "label": "Tuesday" },
        { "value": "3", "label": "Wednesday" },
        { "value": "4", "label": "Thursday" },
        { "value": "5", "label": "Friday" },
        { "value": "6", "label": "Saturday" }
      ],
      "default": "1"
    },
    {
      "type": "textarea",
      "id": "blackout_dates",
      "label": "Blackout dates (YYYY-MM-DD, one per line)",
      "default": ""
    }
  ],
  "presets": [
    {
      "name": "Pickup Calendar"
    }
  ]
}
{% endschema %}

<!-- Load Flatpickr CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr" defer ></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    if (typeof flatpickr === 'undefined') {
      console.warn('Flatpickr is not loaded');
      return;
    }

    const minDays = {{ section.settings.minimum_days_notice | default: 14 }};
    const allowedDay = parseInt({{ section.settings.available_days | default: '1' }});
    const blackoutDates = `{{ section.settings.blackout_dates | strip_newlines }}`.split(/\r?\n/).filter(d => d);

    flatpickr('#pickup-date', {
      dateFormat: "Y-m-d",
      minDate: new Date().fp_incr(minDays),
      disable: [
        function(date) {
          // Disable if date's day is NOT the allowed day OR is in blackout dates
          const dateStr = date.toISOString().split('T')[0];
          return date.getDay() !== allowedDay || blackoutDates.includes(dateStr);
        }
      ]
    });
  });
</script>
