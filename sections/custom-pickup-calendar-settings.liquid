{% comment %} <!-- sections/pickup-calendar.liquid -->
<!-- === ADD FLATPICKR CSS === -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<div class="pickup-calendar">
  <h3>Choose Pickup Date & Time</h3>
 <label for="pickup-date">Pickup Date:</label><br>
                <!-- Changed type="date" to type="text" -->
                <input
                  type="text"
                  id="pickup-date"
                  name="attributes[Pickup Date]"
                  value="{{ cart.attributes['Pickup Date'] }}"
                  placeholder="Select pickup date"
                  required
                ><br><br>

                <label for="pickup-time">Pickup Time:</label><br>
                <input
                  type="time"
                  id="pickup-time"
                  name="attributes[Pickup Time]"
                  value="{{ cart.attributes['Pickup Time'] }}"
                  required
                >
          
</div>

{% schema %}
{
  "name": "Pickup Calendar",
  "settings": [
    {
      "type": "range",
      "id": "minimum_days_notice",
      "label": "Minimum days in advance",
      "min": 0,
      "max": 30,
      "default": 14
    },

  ],
  "presets": [
    {
      "name": "Pickup Calendar"
    }
  ]
}

{% endschema %}

<!-- ADD FLATPICKR JS BEFORE CLOSING BODY (outside all Liquid blocks) -->
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

<!-- Flatpickr JS with defer -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>

<script>
  window.pickupCalendarSettings = {
    minDays: {{ section.settings.minimum_days_notice | default: 14 }},
    allowedDay: parseInt({{ section.settings.available_days | json }}),
    blackoutDates: {{ section.settings.blackout_dates | newline_to_br | split: '<br />' | json }}
  };
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const { minDays, allowedDay, blackoutDates } = window.pickupCalendarSettings;

    flatpickr('#pickup-date', {
      dateFormat: "Y-m-d",
      minDate: new Date(Date.now() + minDays * 24 * 60 * 60 * 1000), // minDays from today
      disable: [
        function(date) {
          // Disable days not matching allowedDay or in blackoutDates
          const day = date.getDay();
          const formatted = date.toISOString().split('T')[0];
          return day !== allowedDay || blackoutDates.includes(formatted);
        }
      ]
    });
  });
</script> {% endcomment %}
<!-- === ADD FLATPICKR CSS === -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

<div class="pickup-calendar">
  <h3>Choose Pickup Date & Time</h3>

  <label for="pickup-date">Pickup Date:</label><br>
  <input
    type="text"
    id="pickup-date"
    name="attributes[Pickup Date]"
    value="{{ cart.attributes['Pickup Date'] }}"
    placeholder="Select pickup date"
    required
  ><br><br>

  <label for="pickup-time">Pickup Time:</label><br>
  <input
    type="time"
    id="pickup-time"
    name="attributes[Pickup Time]"
    value="{{ cart.attributes['Pickup Time'] }}"
    required
  >
</div>

{% schema %}

{
  "name": "Pickup Calendar",
  "settings": [
    {
      "type": "range",
      "id": "minimum_days_notice",
      "label": "Minimum days in advance",
      "min": 0,
      "max": 30,
      "default": 2
    },
    {
      "type": "checkbox",
      "id": "allow_sunday",
      "label": "Allow Sunday",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "allow_monday",
      "label": "Allow Monday",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "allow_tuesday",
      "label": "Allow Tuesday",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "allow_wednesday",
      "label": "Allow Wednesday",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "allow_thursday",
      "label": "Allow Thursday",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "allow_friday",
      "label": "Allow Friday",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "allow_saturday",
      "label": "Allow Saturday",
      "default": false
    }

  ],
  "presets": [
    {
      "name": "Pickup Calendar"
    }
  ]
}
{% endschema %}


<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr" defer ></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const minDays = {{ section.settings.minimum_days_notice | default: 2 }};
const allowedDays = [];
{% if section.settings.allow_sunday %}allowedDays.push("0");{% endif %}
{% if section.settings.allow_monday %}allowedDays.push("1");{% endif %}
{% if section.settings.allow_tuesday %}allowedDays.push("2");{% endif %}
{% if section.settings.allow_wednesday %}allowedDays.push("3");{% endif %}
{% if section.settings.allow_thursday %}allowedDays.push("4");{% endif %}
{% if section.settings.allow_friday %}allowedDays.push("5");{% endif %}
{% if section.settings.allow_saturday %}allowedDays.push("6");{% endif %}

    const blackoutDates = {{ section.settings.blackout_dates | newline_to_br | split: '<br />' | json }};

    flatpickr('#pickup-date', {
      dateFormat: "Y-m-d",
      minDate: new Date().fp_incr(minDays),
      disable: [
        function(date) {
          const day = date.getDay().toString(); // convert to string for comparison
          const dateStr = date.toISOString().split('T')[0]; // format to YYYY-MM-DD
          return !allowedDays.includes(day) || blackoutDates.includes(dateStr);
        }
      ]
    });
  });
</script>
